
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.com/1.0/framework/framework/">
      
      <link rel="icon" href="../../assets/graphics/logo.svg">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>Framework - atomos | Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-321879236"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-321879236",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-321879236"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#framework" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        <aside class="md-banner md-banner--warning">
          
        </aside>
      </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://github.com/juliusotte/atomos" title="atomos | Documentation" class="md-header__button md-logo" aria-label="atomos | Documentation" data-md-component="logo">
      
  <img src="../../assets/graphics/banner-light.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            atomos | Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Framework
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_3" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to automatic mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to automatic mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_3">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
      </form>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Select language">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="/en/" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
                
                <li class="md-select__item">
                  <a href="/de/" hreflang="de" class="md-select__link">
                    Deutsch
                  </a>
                </li>
                
            </ul>
          </div>
        </div>
      </div>
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Index
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../about/" class="md-tabs__link">
      About
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://github.com/juliusotte/atomos" title="atomos | Documentation" class="md-nav__button md-logo" aria-label="atomos | Documentation" data-md-component="logo">
      
  <img src="../../assets/graphics/banner-light.svg" alt="logo">

    </a>
    atomos | Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Index
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

  



<h1 id="framework">Framework</h1>
<h2 id="objective">Objective</h2>
<blockquote>
<p>In computer programming, a software framework is an abstraction in which software, providing generic functionality,
can be selectively changed by additional user-written code, thus providing application-specific software. It provides
a standard way to build and deploy applications and is a universal, reusable software environment that provides
particular functionality as part of a larger software platform to facilitate the development of software applications,
products and solutions. Software frameworks may include support programs, compilers, code libraries, toolsets, and
application programming interfaces (APIs) that bring together all the different components to enable development of a
project or system. (Wikipedia)</p>
</blockquote>
<p>The objective of this event-driven framework is to provide a system of high-level abstraction components
that act as building blocks to develop performant, secure, resilient, distributed, and scalable microservices.</p>
<h2 id="building-blocks">Building Blocks</h2>
<p>Besides the <a href="../../architecture/architecture/">system architecture</a>, the framework provides a variety of system
components that act as the building blocks to create microservices.</p>
<h2 id="domain">Domain</h2>
<blockquote>
<p>A sphere of knowledge, influence, or activity. The subject area to which the user applies a program is the domain of
the software. (Eric Evans)</p>
</blockquote>
<p>The domain contains <strong>models</strong>, <strong>events</strong>, and <strong>commands</strong> that in conjunction abstract the reality or fictional
entities. <strong>Domain engineering / modeling</strong> refers to the process of abstracting real-world entities to digital
domain entities.</p>
<p>The framework provides abstract bases for custom models, events, and commands:</p>
<p><code>atomos/core/domain/events/event.py</code></p>
<pre><code class="language-python">@dataclass
class Event:
    pass
</code></pre>
<pre><code class="language-python">@dataclass
class UserCreated(event.Event):
    username: Optional[str]
    email: Optional[str]
    roles: Optional[List[role.Role]] = field(default_factory=lambda: [])
</code></pre>
<p><code>atomos/core/domain/commands/command.py</code></p>
<pre><code class="language-python">@dataclass
class Command:
    pass
</code></pre>
<pre><code class="language-python">@dataclass
class CreateUser(command.Command):
    username: str
    password: str
    email: str
    roles: Optional[List[role.Role]] = field(default_factory=lambda: [])
</code></pre>
<p><code>atomos/core/domain/model/model.py</code></p>
<pre><code class="language-python">class EventQueue(abc.ABC):
    events: Optional[List[event.Event]] = []


class Model(EventQueue):
    id: Optional[str] = str(uuid4())
</code></pre>
<p>The <code>Model</code> base inherits the abstract base class <code>EventQueue</code>, which optionally stores a list of events. This allows
the service layer's message bus (<code>atomos/core/service/bus/message_bus.py</code>) to dynamically monitor newly triggered events
that relate to the model.</p>
<pre><code class="language-python">@dataclass
class User(model.Model):
    username: str
    password: Optional[str] = None
    email: Optional[str] = None
    roles: Optional[List[role.Role]] = field(default_factory=lambda: [])
    id: Optional[uuid.UUID] = uuid.uuid4()

    def __hash__(self):
        return hash(self.username)

    def __eq__(self, other):
        return isinstance(other, User) and self.id is other.id
</code></pre>
<h3 id="adapters">Adapters</h3>
<h4 id="repository">Repository</h4>
<blockquote>
<p>Repositories are classes or components that encapsulate the logic required to access data sources. They centralize
common data access functionality, providing better maintainability and decoupling the infrastructure or technology
used to access databases from the domain model layer. (Microsoft)</p>
</blockquote>
<p>Every repository defines a domain aggregate. The events and commands that are received by the service layer's message
bus will be handled by a unit of work (UOW), which defines an atomic update to the data persistence layer, in particular
the repository.</p>
<p>Thus, an abstract UOW depends on an abstract repository. Concrete UOW implementations (like a SQLAlchemy UOW) depend on
concrete repository implementations (like a SQLAlchemy repository implementation):</p>
<p><img src='uow-repository-communication.drawio.svg' alt='uow-repository-communication' /></p>
<p>The framework provides an abstract base repository class that acts as an initial building block to develop custom
repository aggregates:</p>
<p><code>atomos/core/adapters/repository/repository.py</code></p>
<pre><code class="language-python">class Repository(abc.ABC):
    collected_entities: Set[model.Model]

    def __init__(self):
        self.collected_entities = set()
</code></pre>
<p>A custom repository aggregate could then be defined as an abstract repository itself, depending on the abstract base
repository:</p>
<pre><code class="language-python">class UserRepository(repository.Repository):
    def __init__(self):
        super().__init__()

    async def create_user(
        self,
        username: str,
        password: str,
        email: Optional[str],
    ):
        await self._create_user(username, password, email)
        self.collected_entities.add(user_model.User(username, password, email))

    async def get_user(self, username: Optional[str] = None, email: Optional[str] = None) -&gt; Optional[user_model.User]:
        result = await self._get_user(username=username, email=email)
        if result:
            self.collected_entities.add(result)
        return result

    async def query_users(self, **criterion) -&gt; Iterable[user_model.User]:
        results = await self._query_users(**criterion)
        if results:
            self.collected_entities.union(results)
        return results

    async def update_user(self, username: Optional[str], email: Optional[str], **update):
        await self._update_user(username, email, **update)

    async def delete_user(self, username: Optional[str] = None, email: Optional[str] = None):
        await self._delete_user(username=username, email=email)

    @abc.abstractmethod
    async def _create_user(
        self,
        username: str,
        password: str,
        email: Optional[str],
    ):
        raise NotImplementedError

    @abc.abstractmethod
    async def _get_user(self, username: Optional[str], email: Optional[str]) -&gt; Optional[user_model.User]:
        raise NotImplementedError

    @abc.abstractmethod
    async def _query_users(self, **criterion) -&gt; Iterable[user_model.User]:
        raise NotImplementedError

    @abc.abstractmethod
    async def _update_user(self, username: Optional[str], email: Optional[str], **update):
        raise NotImplementedError

    @abc.abstractmethod
    async def _delete_user(self, **criterion):
        raise NotImplementedError
</code></pre>
<p>The framework provides an abstract base SQLAlchemy repository that inherits the abstract base repository:</p>
<p><code>atomos/core/adapters/repository/sqlalchemy_repository.py</code></p>
<pre><code class="language-python">class SQLAlchemyRepository(repository.Repository, abc.ABC):
    def __init__(self, session: Session = factory.DEFAULT_SESSION_FACTORY()):
        super().__init__()
        self.session: Session = session
</code></pre>
<p>The SQLAlchemy repository base can then be applied to create custom SQLAlchemy repository implementations:</p>
<pre><code class="language-python">class SQLAlchemyUserRepository(
    sqlalchemy_repository.SQLAlchemyRepository,
    repository.IdentityRepository
):
    def __init__(self, session: Session = factory.DEFAULT_SESSION_FACTORY()):
        super().__init__(session)
        self.session = session

    async def _create_user(
        self,
        username: str,
        password: str,
        email: Optional[str],
    ):
        if not await self._get_user(username=username, email=email):
            self.session.add(user_model.User(username, password, email))

    async def _get_user(self, **criterion) -&gt; Optional[user_model.User]:
        data = {
            k: v
            for k, v in criterion.items()
            if k in ['username', 'email']
            and v is not None
        }
        if not data:
            return None
        return self.session.query(user_model.User).filter_by(**data).first()

    async def _query_users(self, **criterion) -&gt; Iterable[user_model.User]:
        return self.session.query(user_model.User).filter_by(**criterion).all()

    async def _update_user(self, username: Optional[str], email: Optional[str], **update):
        self.session.query(user_model.User).filter_by(username=username, email=email).update(**update)

    async def _delete_user(self, **criterion):
        result = await self._get_user(**criterion)
        if result:
            self.session.delete(result)
</code></pre>
<h4 id="event-messaging-message-broker">(Event) Messaging | Message Broker</h4>
<p><strong>Event messaging</strong> describes an architectural approach in which the communication between system components happens by
exchanging events. An event defines an immutable action that was triggered by a user/client or system component itself.</p>
<p>A <strong>message broker</strong> is an intermediary message-oriented middleware that is responsible to receive, process, and deliver
event messages. The messages are triggered by so-called producers/publisher, while the processed messages are delived to
corresponding consumers/subscribers. Producers and consumers do not necessarily need to know about each other's
existence. A message-oriented middleware (MOM), like a message broker, reduces the overall network complexity by
creating a star topology, thus enabling a loose coupling between the producers and consumers. In contrast, a message
broker introduces a highly system-critical component that needs to be designed and developed resilient in the dimensions
of security, performance, and scalability.</p>
<p>A message broker can additionally provide asynchronous communication between producers and consumers of messages by
implementing a <strong>message queue</strong>. Erroneous message processes can be temporarily stored on a <strong>dead-letter queue</strong> in
order to ensure delivery and data consistency.</p>
<p><img src='pub-sub.drawio.svg' alt='pub-sub' /></p>
<p><img src='pub-sub-broker.drawio.svg' alt='pub-sub-broker' /></p>
<p>The framework provides an abstract message broker, as well as a concrete Redis <strong>publish/subscribe-broker (pub/sub)</strong>
implementation.</p>
<p><img src='messaging.drawio.svg' alt='messaging' /></p>
<p><code>atomos/core/adapters/messaging/message_broker.py</code></p>
<pre><code class="language-python">class MessageBroker(abc.ABC):
    @abc.abstractmethod
    async def publish(self, channel: str, event: event.Event):
        logger.info('publishing: channel=%s, events=%s', channel, event)
        raise NotImplementedError

    @abc.abstractmethod
    async def subscribe(self, channel: str):
        logger.info('subscribing: channel=%s', channel)
        raise NotImplementedError

    @abc.abstractmethod
    async def process(self, handle: Callable[..., Awaitable]):
        raise NotImplementedError
</code></pre>
<p><code>atomos/core/adapters/messaging/redis_pub_sub_broker.py</code></p>
<pre><code class="language-python">class RedisPubSubBroker(message_broker.MessageBroker):
    def __init__(self, host: str = config.REDIS_HOST, port: int = config.REDIS_PORT):
        self._client = redis.Redis(host=host, port=port)
        self._pub_sub = self._client.pubsub(ignore_subscribe_messages=True)

    async def publish(self, channel: str, event: event.Event):
        self._client.publish(channel, json.dumps(asdict(event)))

    async def subscribe(self, channel: str):
        self._pub_sub.subscribe(channel)

    async def process(self, handle: Callable[..., Awaitable]):
        for message in self._pub_sub.listen():
            await handle(message)
</code></pre>
<h3 id="service-layer">Service Layer</h3>
<h4 id="unit-of-work-uow">Unit of Work (UOW)</h4>
<p>A unit of work (UOW) defines an abstraction around an atomic update to the data layer (in particular the a repository
adapter in this architecture). The UOW enforces data integrity and consistency by monitoring the execution of state
changes, comitting the updates in case of success, or rolling back in case of failure.</p>
<p>The framework provides generic abstractions for the UOW that act as the building blocks to create custom UOW
implementations:</p>
<p><code>atomos/core/service/uow/unit_of_work.py</code></p>
<pre><code class="language-python">T = TypeVar('T', bound=repository.Repository)

class UnitOfWork(Generic[T], contextlib.AbstractAsyncContextManager, abc.ABC):
    repository: T

    async def __aenter__(self) -&gt; UnitOfWork:
        return self

    async def __aexit__(self, *args):
        await self.rollback()

    async def commit(self):
        await self._commit()

    async def rollback(self):
        await self._rollback()

    def collect_new_events(self):
        for entity in self.repository.collected_entities:
            while entity.events:
                yield entity.events.pop(0)

    @abc.abstractmethod
    async def _commit(self):
        raise NotImplementedError

    @abc.abstractmethod
    async def _rollback(self):
        raise NotImplementedError
</code></pre>
<p><code>atomos/core/service/uow/sqlalchemy_unit_of_work.py</code></p>
<pre><code class="language-python">SessionFactory = Callable[..., Session]

T = TypeVar('T', bound=sqlalchemy_repository.SQLAlchemyRepository)


class SQLAlchemyUnitOfWork(Generic[T], unit_of_work.UnitOfWork[T], abc.ABC):
    def __init__(
        self,
        repository_factory: Type[sqlalchemy_repository.SQLAlchemyRepository],
        session_factory: SessionFactory = factory.DEFAULT_SESSION_FACTORY,
    ):
        self.repository_factory: Type[sqlalchemy_repository.SQLAlchemyRepository] = repository_factory
        self.session_factory: SessionFactory = session_factory

    async def __aenter__(self):
        self.session: Session = self.session_factory()
        self.repository: T = self.repository_factory(self.session)
        return await super().__aenter__()

    async def __aexit__(self, *args):
        await super().__aexit__(*args)
        self.session.close()

    async def _commit(self):
        self.session.commit()

    async def _rollback(self):
        self.session.rollback()
</code></pre>
<p>The generic design of the UOW bases allows to easily create custom UOW implementations: </p>
<pre><code class="language-python">class SQLAlchemyUserUnitOfWork(
    sqlalchemy_unit_of_work.SQLAlchemyUnitOfWork[sqlalchemy_repository.SQLAlchemyUserRepository],
):
    def __init__(self, session_factory: sqlalchemy_unit_of_work.SessionFactory = factory.DEFAULT_SESSION_FACTORY):
        super().__init__(sqlalchemy_repository.SQLAlchemyUserRepository, session_factory)
</code></pre>
<h2 id="references">References</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Software_framework">Software framework (Wikipedia)</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design">Design the infrastructure persistence layer (Microsoft)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Domain_(software_engineering)">Domain (software engineering) (Wikipedia)</a></li>
</ul>

              
            </article>
            
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 Julius Otte â€“ <a href="#__consent">Change cookie settings</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.prune", "navigation.indexes", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>